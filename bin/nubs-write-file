#! /usr/bin/env bash

# Write a file (combines add and commit) to a repository.
# The file content is read from stdin.

REPO_NAME="$1"
FILE_NAME="$2"

echo WRITE Called with $1 $2 >> /tmp/hello


if [[ -z "${REPO_NAME}" ]] ; then
  echo "Usage: nubs-init REPO FILENAME"
  exit 1
fi

REPO_BASENAME=$(basename -- "${REPO_NAME}")

if [[ "${REPO_NAME}" != "${REPO_BASENAME}" ]] ; then
  echo "The repository name can't be a path."
  exit 1
fi

if [[ -z "${FILE_NAME}" ]] ; then
  echo "Usage: nubs-init REPO FILENAME"
  exit 1
fi

FILE_BASENAME=$(basename -- "${FILE_NAME}")

if [[ "${FILE_BASENAME}" != "${FILE_NAME}" ]] ; then
  echo "The filename can't be a path."
  exit 1
fi


BLOB_SHA1=$(git \
  --git-dir "/nubs/${REPO_NAME}.git" \
  hash-object -w --stdin)

git --git-dir "/nubs/${REPO_NAME}.git" read-tree HEAD > /dev/null 2>&1 \
  || git --git-dir "/nubs/${REPO_NAME}.git" read-tree --empty
git --git-dir "/nubs/${REPO_NAME}.git" update-index \
  --add \
  --cacheinfo 0644 "${BLOB_SHA1}" "${FILE_NAME}"

TREE_SHA1=$(git --git-dir "/nubs/${REPO_NAME}.git" write-tree)

PARENT_SHA1=$(git --git-dir=/nubs/hello.git show-ref -s master)

WITH_PARENT=""
if [[ -n "${PARENT_SHA1}" ]] ; then
  WITH_PARENT="-p ${PARENT_SHA1}"
fi

cat > "/nubs/${REPO_NAME}.git/tempfile" <<EOF
yourname
your@email.com
2013 12:20:15 +0200
committername
committer@email.com
2013 10:13:15 +0200
EOF

COMMIT_SHA1=$(cat "/nubs/${REPO_NAME}.git/tempfile" | \
 git --git-dir "/nubs/${REPO_NAME}.git" \
   commit-tree ${TREE_SHA1} ${WITH_PARENT})

git \
  --git-dir "/nubs/${REPO_NAME}.git" \
  update-ref refs/heads/master ${COMMIT_SHA1}
